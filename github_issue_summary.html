<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en">

<head>

    <!-- Meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">


    <!-- CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu">

    <link rel="stylesheet" href="http://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.4/css/select2.min.css" rel="stylesheet" />

    <link rel="stylesheet" href="css/style.css">


    <!-- JavaScript -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>

    <script src="https://d3js.org/d3.v5.js"
        integrity="sha384-qbNa7U27VV0Cghe/43y8zEMkmA5M4VxV6MI0k0vdVJKTrBoT2SnBqwccpD0vX+Is"
        crossorigin="anonymous"></script>

    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>


    <!-- <script type="text/javascript" src="src/jquery.multiselect.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script>

    <!--*******************************************-->
    <!--***** IMPORT EXTERNAL JAVASCRIPT CODE *****-->
    <script src="js/bar_chart.js"></script>
    <script src="js/donut_chart.js"></script>
    <!--*******************************************-->

    <!-- 
    <title>CAP 4744/5745 - Interactive Data Visualization - Project 3</title> -->

</head>

<body>

    <!-- <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="index.html">Project 3: Rifat Ara Proma</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
            <li class="nav-item"><a class="nav-link" href="titanic.html">Titanic Passenger List</a></li>
            <li class="nav-item"><a class="nav-link" href="health_stroke.html">Stroke Prediction</a></li>
        </ul>
    </div>
</nav> -->

    <div class="page">
        <svg id="vis_1" name="vis_1" class="default_svg"></svg>
        <div id="commits"></div>
        <div class="default_svg" style="height: 500px;">
            <div>
                <select id="updateCountSelectButton" class="js-select2" onchange="updateLineCountChange()"
                    multiple="multiple">
                </select>
            </div>
            <div id="vis_2" style="text-align:center;"></div>
            <!-- <svg id="vis_2" name="vis_2" class="default_svg" style="border: none;"></svg> -->
        </div>
    </div>


    <script>
        let data = null;
        let vis_1 = null;
        let commits = null;
        let commit_div = document.getElementById('commits');
        let vis_2 = null;
        let updated_files_summary = [];
        let file_update_freq = [];


        d3.csv("data/commit_details.csv", (row, i) => {
            return {
                message: row.message,
                created: row.created * 1000, // millisecond
                files_updated: row.files_updated,
                diff: row.diff
            };
        }).then(rows => {

            commits = rows;
            let file_list = [];
            let file_update_count = {};
            commits.forEach((commit) => {
                let files = commit.files_updated.replace("[", "").replace("]", "").replaceAll("'", "").split(',');
                let files_diff = getFilesDiffList(commit.diff);
                files.forEach(file => {
                    let fileName = file.trim();

                    if (!file_list.find(file => file == fileName)){
                        file_list.push(fileName);
                    }
                    
                    files_diff.forEach(file_diff => {
                        if (file_update_count[fileName] == undefined) {
                            file_update_count[fileName] = 0;
                        }
                        if (file_diff.name == fileName) {
                            file_update_count[fileName] += file_diff.added_lines.length + file_diff.deleted_lines.length;
                        }
                    });
                });
            });

            var dropDownForFiles = document.getElementById("updateCountSelectButton");

            file_list.forEach(file =>{
                file_update_freq.push({name: file, update_freq: file_update_count[file]});
            });

            file_update_freq.sort((a, b) => (a.update_freq > b.update_freq) ? -1 : 1);

            let top_five = [];
            let i = 0;
            file_update_freq.forEach(entry =>{
                var option = document.createElement("option");
                option.value = i; // setting index of the entry as value to access it easy later on
                option.text = entry.name;
                dropDownForFiles.appendChild(option);
                
                
                if (top_five.length != 5){
                    top_five.push(i);
                }
                
                i++;
            });

            $("#updateCountSelectButton").val(top_five);
            //show top 5 most updated files
            vis_2 = load_file_update_summary("#vis_2", file_update_freq.slice(0, 5));

            d3.csv("data/issue_details.csv", (row, i) => {
                return {
                    title: row.title,
                    created: row.created * 1000, // millisec
                    closed: row.closed * 1000,
                };
            }).then(rows => {
                data = rows;

                let title_vis1 = "Issues with their creation and closing dates";
                let x_title_vis1 = "Date";
                vis_1 = load_timeline("#vis_1", data, title_vis1, "created", "closed", "title", x_title_vis1);

            }).catch(error => {
                console.log(error);
            });

        }).catch(error => {
            console.log(error);
        });


        function showCommitBetween(time1, time2) {
            commit_div.innerHTML = '';
            var i = 0;
            commits.forEach(commit => {
                if (commit.created >= time1 && commit.created <= time2) {
                    commit_div.innerHTML += '<button type="button" class="collapsible">' + commit.message + '</button><div class="content" id=' + i + '></div>';
                    // delete the first and last square bracket and also the first quotes
                    let files = commit.files_updated.replace("[", "").replace("]", "").replaceAll("'", "").split(', ');
                    let files_diff = getFilesDiffList(commit.diff);
                    files.forEach(file => {
                        document.getElementById(i).innerHTML += '<p>' + file;

                        files_diff.forEach(diff => {
                            if (diff.name == file) {
                                document.getElementById(i).innerHTML += "Added lines: " + diff.added_lines.length
                                document.getElementById(i).innerHTML += " Deleted lines: " + diff.deleted_lines.length + '</p> </div>'
                            }
                        });
                    })
                }

                i++;
            });

            var coll = document.getElementsByClassName("collapsible");

            for (i = 0; i < coll.length; i++) {
                coll[i].addEventListener("click", function () {
                    this.classList.toggle("active");
                    var content = this.nextElementSibling;
                    if (content.style.display === "block") {
                        content.style.display = "none";
                    } else {
                        content.style.display = "block";
                    }
                });
            }
        }

        function getCommitBetween(time1, time2) {
            var commitBetweenInterval = [];
            commits.forEach(commit => {

                if (commit.created >= time1 && commit.created <= time2) {
                    commitBetweenInterval.push(commit);
                }

            });

            return commitBetweenInterval;
        }

        function getFilesDiffList(diffString) {
            //console.log(diffString);
            diff = diffString.replace('[', '');
            indexOfLastSquareBracket = diff.lastIndexOf(']');
            diff = diff.substr(0, indexOfLastSquareBracket);
            diff = diff.split("),");
            files_diff_list = [];

            diff.forEach((file => {
                // console.log(file);
                file = file.replace('(', '').replace(')', '').split(', [');
                files_diff = { name: "", deleted_lines: [], added_lines: [] };
                files_diff.name = file[0].replaceAll("'", '').replace(' ', '');
                files_diff.deleted_lines = file[1].replace(']', '').split(', ');
                files_diff.added_lines = file[2].replace(']', '').split(', ');
                files_diff_list.push(files_diff);
            }));

            return files_diff_list;
        }

        function updateLineCountChange() {
            let selected = $('#updateCountSelectButton').select2('data');
            let data = [];
            selected.forEach(selection =>{
                data.push(file_update_freq[selection.id])
            })
            vis_2 = null;
            vis_2 = load_file_update_summary("#vis_2", data);
        }

        //$('#updateCountSelectButton').select2().find('option').prop('selected', 'selected').end().select2();
        $('#updateCountSelectButton').select2({placeholder: "Select files"});
        // $('#updateCountSelectButton').val(file_list);

    </script>

</body>

</html>